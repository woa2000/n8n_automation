{"updatedAt":"2025-10-24T22:01:17.000Z","createdAt":"2025-10-22T23:25:22.276Z","id":"mBhwGa9jWMRBnPXS","name":"Mensagens WhatsApp copy","active":false,"isArchived":false,"nodes":[{"parameters":{"updates":["messages"],"options":{}},"type":"n8n-nodes-base.whatsAppTrigger","typeVersion":1,"position":[-384,-448],"id":"8e1e4056-242a-49ad-b075-dbed1552a9c7","name":"WhatsApp Trigger - ECC","webhookId":"bcb47508-e31c-49dd-8e43-911eb99b763f","credentials":{"whatsAppTriggerApi":{"id":"hlCrKgEKRoeajyvg","name":"WhatsApp OAuth account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"version":2,"leftValue":"","caseSensitive":true,"typeValidation":"strict"},"combinator":"and","conditions":[{"id":"2fc5c912-629b-4cbe-b5e3-7e3f0651c628","operator":{"type":"string","operation":"equals"},"leftValue":"={{ $json.messages[0].type }}","rightValue":"text"}]},"renameOutput":true,"outputKey":"Text"},{"conditions":{"options":{"version":2,"leftValue":"","caseSensitive":true,"typeValidation":"strict"},"combinator":"and","conditions":[{"id":"26a3d85c-0815-48ff-85ce-713129a1107c","operator":{"name":"filter.operator.equals","type":"string","operation":"equals"},"leftValue":"={{ $json.messages[0].type }}","rightValue":"audio"}]},"renameOutput":true,"outputKey":"Audio"},{"conditions":{"options":{"version":2,"leftValue":"","caseSensitive":true,"typeValidation":"strict"},"combinator":"and","conditions":[{"id":"840b95b8-6559-4fb7-b32c-651451d6d0d2","operator":{"name":"filter.operator.equals","type":"string","operation":"equals"},"leftValue":"={{ $json.messages[0].type }}","rightValue":"image"}]},"renameOutput":true,"outputKey":"Image"},{"conditions":{"options":{"version":2,"leftValue":"","caseSensitive":true,"typeValidation":"strict"},"combinator":"and","conditions":[{"id":"3e7a07f9-b785-450c-8c68-f6b276838503","operator":{"name":"filter.operator.equals","type":"string","operation":"equals"},"leftValue":"={{ $json.messages[0].type }}","rightValue":"document"}]},"renameOutput":true,"outputKey":"Document"}]},"options":{}},"id":"9cce6054-53cc-4c3a-b4b1-8fcedc39c99e","name":"Route Types","type":"n8n-nodes-base.switch","position":[-160,-480],"typeVersion":3.2},{"parameters":{"jsCode":"// pega o timestamp em segundos do JSON de entrada\nconst tsSegundos = Number($('Convert Json3').first().json.momment); \n\n// converte para milissegundos\nconst tsMilissegundos = tsSegundos * 1000;\n\n// cria o objeto Date\nconst data = new Date(tsMilissegundos);\n\n// formata a data em YYYY-MM-DD HH:mm:ss\nconst data_formatada = data.getFullYear() + '-' +\n  String(data.getMonth() + 1).padStart(2, '0') + '-' +\n  String(data.getDate()).padStart(2, '0') + ' ' +\n  String(data.getHours()).padStart(2, '0') + ':' +\n  String(data.getMinutes()).padStart(2, '0') + ':' +\n  String(data.getSeconds()).padStart(2, '0');\n\n// retorna os dois formatos\nreturn {\n  timestamp_original: tsSegundos,\n  timestamp_milliseconds: tsMilissegundos,\n  data_formatada\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1392,-400],"id":"fb311cae-0488-40c2-bd97-b0d6a8bc7915","name":"Code3"},{"parameters":{"method":"POST","url":"https://gerencial.ecconline.com.br/api/WhatsApp/MensagemRecebida","sendBody":true,"specifyBody":"json","jsonBody":"={\n\"instanceId\" :\"{{ $('Convert Json3').item.json.instanceId }}\",\n\"messageId\":\"{{ $('Convert Json3').item.json.messageId }}\",\n\"phone\":\"{{ $('Convert Json3').item.json.phone }}\",\n\"fromMe\":false,\n\"momment\":\"{{ $json.timestamp_milliseconds }}\",\n\"status\":\"{{ $('Convert Json3').item.json.status }}\",\n\"chatName\":\"{{ $('Convert Json3').item.json.chatName }}\",\n\"senderName\":\"{{ $('Convert Json3').item.json.senderName }}\",\n\"type\":\"{{ $('Convert Json3').item.json.type }}\",\n\"document\":{\n  \"mimeType\":\"{{ $('Download Document').item.json.mime_type }}\",\n  \"documentUrl\":\"https://eccstoragesistema.blob.core.windows.net/anexos-ecc/whatsapp/{{ $('Download Document').item.json.id }}.{{ $('Download Document').item.json.mime_type.split(\"/\")[1] }}\",\n  \"thumbnailUrl\":\"https://eccstoragesistema.blob.core.windows.net/anexos-ecc/whatsapp/{{ $('Download Document').item.json.id }}.{{ $('Download Document').item.json.mime_type.split(\"/\")[1] }}\",\n\"fileName\":\"{{ $('Download Document').item.json.id }}.{{ $('Download Document').item.json.mime_type.split(\"/\")[1] }}\"\n  }\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1648,-400],"id":"058fff85-8397-47e8-a935-1bbfb88606d8","name":"HTTP Request3"},{"parameters":{"assignments":{"assignments":[{"id":"fd57ae57-a577-49f0-b036-722dc1917120","name":"instanceId","value":"={{ $json.metadata.phone_number_id }}","type":"string"},{"id":"f1bed616-1835-47a5-973e-ee31e0ab3ae9","name":"messageId","value":"={{ $json.messages[0].id }}","type":"string"},{"id":"0de31f4f-b5f3-41f7-8adc-37f772e71f01","name":"phone","value":"={{ $json.contacts[0].wa_id }}","type":"string"},{"id":"6f207bc5-537c-43a1-921f-00c3acd1461f","name":"fromMe","value":false,"type":"boolean"},{"id":"cddeaac4-2ef6-48ea-a6a7-5b72f6211358","name":"momment","value":"={{ $json.messages[0].timestamp }}","type":"string"},{"id":"9c9d1c47-684a-4f6e-bb3e-085c9c58510c","name":"status","value":"RECEIVED","type":"string"},{"id":"6f141cc7-52c6-44f1-9888-6f50a4adf9e9","name":"chatName","value":"={{ $json.contacts[0].profile.name }}","type":"string"},{"id":"fe2526ac-f2f9-4f5c-8cf1-bd92eb53addc","name":"senderPhoto","value":"","type":"string"},{"id":"ed4678ef-1ad2-42fa-aff2-c9d24b4b0c56","name":"senderName","value":"={{ $json.contacts[0].profile.name }}","type":"string"},{"id":"707725eb-e306-4e2c-ac26-08a19b46b140","name":"type","value":"={{ $json.messages[0].type }}","type":"string"},{"id":"c968c658-aa8a-4b55-a7c5-eb8d7973d576","name":"document","value":"={\n\"mime_type\":\"{{ $json.messages[0].document.mime_type }}\",\n\"sha256\":\"{{ $json.messages[0].document.sha256 }}\",\n\"id\":\"{{ $json.messages[0].document.id }}\"\n} ","type":"object"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[192,-400],"id":"36a05eb2-4589-43cf-ab93-e5e315971945","name":"Convert Json3"},{"parameters":{"resource":"media","operation":"mediaUrlGet","mediaGetId":"={{ $json.document.id }}"},"id":"00f2b84e-da09-4b9c-bacf-d13bc72e6ab4","name":"Gets WhatsApp Document Source URL","type":"n8n-nodes-base.whatsApp","position":[496,-400],"webhookId":"bbe62f3d-8788-49d4-aae6-9e9411446d44","typeVersion":1,"credentials":{"whatsAppApi":{"id":"O4KPds99LtlNbFl3","name":"WhatsApp account - ECC"}}},{"parameters":{"url":"={{ $json.url }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","options":{"response":{"response":{"responseFormat":"file","outputPropertyName":"document"}}}},"id":"136078b6-2272-40d7-a0e5-d8dce11877dd","name":"Download Document","type":"n8n-nodes-base.httpRequest","position":[720,-400],"typeVersion":4.2,"credentials":{"httpBearerAuth":{"id":"xX5EYametdjtA3Mi","name":"WhatsApp Key"}}},{"parameters":{"resource":"blob","operation":"create","container":{"__rl":true,"value":"anexos-ecc","mode":"list","cachedResultName":"anexos-ecc"},"blobCreate":"=whatsapp/{{ $json.id }}.{{ $binary.document.fileExtension }}","binaryPropertyName":"document","options":{"contentType":"={{ $binary.document.mimeType || 'application/octet-stream' }}","filename":"={{ $json.id }}.{{ $binary.document.fileExtension }}"},"requestOptions":{}},"type":"n8n-nodes-base.azureStorage","typeVersion":1,"position":[1152,-400],"id":"41e58eb4-9e96-4491-a008-03b8f9f524d3","name":"Create Document","credentials":{"azureStorageSharedKeyApi":{"id":"kmykU0TBhi2DIJYs","name":"Azure Storage account"}}},{"parameters":{"jsCode":"{\n  \"parameters\": {\n    \"functionCode\": \"const item = $input.item;\\nitem.binary = item.binary || {};\\nconst doc = item.binary.document || item.binary.data || null; // ajuste se seu Binary Property tiver outro nome\\nif (!doc) {\\n  return item; // nada a fazer\\n}\\n\\n// Descobrir id/ext\\nconst id = item.json.id || Date.now();\\nconst ext = doc.fileExtension || (doc.mimeType && doc.mimeType.split('/')[1]) || 'bin';\\n\\n// Monta nome e SANEIA p/ header HTTP\\nlet fname = `${id}.${ext}`\\n  .normalize('NFD').replace(/[\\\\u0300-\\\\u036f]/g, '')   // remove acentos\\n  .replace(/[^\\\\x20-\\\\x7E]/g, '')                       // só ASCII visível\\n  .replace(/[\\\\\\\\\\\"]/g, '')                             // remove aspas e \\\\\\n  .replace(/[;\\\\r\\\\n]/g, '')                            // remove ; e quebras\\n  .replace(/[^A-Za-z0-9._-]/g, '_');                    // demais → _\\n\\ndoc.fileName = fname;                        // força um nome seguro\\nif (!doc.mimeType) doc.mimeType = 'application/octet-stream';\\n\\nreturn item;\"\n  },\n  \"name\": \"Sanitize Binary Filename (Function)\",\n  \"type\": \"n8n-nodes-base.functionItem\",\n  \"typeVersion\": 1,\n  \"position\": [800, 400]\n}\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[928,-400],"id":"04b8bbb7-de0f-4c58-9377-8c0f0f8d6997","name":"Code"}],"connections":{"WhatsApp Trigger - ECC":{"main":[[{"node":"Route Types","type":"main","index":0}]]},"Route Types":{"main":[[],[{"node":"Convert Json3","type":"main","index":0}],[],[]]},"Code3":{"main":[[{"node":"HTTP Request3","type":"main","index":0}]]},"Convert Json3":{"main":[[{"node":"Gets WhatsApp Document Source URL","type":"main","index":0}]]},"Gets WhatsApp Document Source URL":{"main":[[{"node":"Download Document","type":"main","index":0}]]},"Download Document":{"main":[[{"node":"Code","type":"main","index":0}]]},"Create Document":{"main":[[{"node":"Code3","type":"main","index":0}]]},"Code":{"main":[[{"node":"Create Document","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"WhatsApp Trigger - ECC":[{"json":{"messaging_product":"whatsapp","metadata":{"display_phone_number":"551140637950","phone_number_id":"804952052707181"},"contacts":[{"profile":{"name":"Thiago Redigulo"},"wa_id":"5511998590806"}],"messages":[{"from":"5511998590806","id":"wamid.HBgNNTUxMTk5ODU5MDgwNhUCABIYFDNBQUJEQUVCODlFOTgxRDFGMzZGAA==","timestamp":"1761169455","type":"audio","audio":{"mime_type":"audio/ogg; codecs=opus","sha256":"XvyATMFm6YGddORmTxmuVyQEiLXXX8XTHmusJKRxiAk=","id":"1511449803318221","voice":true}}],"field":"messages"}}]},"versionId":"97c422e3-bc6c-47bb-bf9c-c6e47870f06a","triggerCount":2,"shared":[{"updatedAt":"2025-10-22T23:25:22.282Z","createdAt":"2025-10-22T23:25:22.282Z","role":"workflow:owner","workflowId":"mBhwGa9jWMRBnPXS","projectId":"5dTxE8vBWJ6kQMrp"}],"tags":[]}